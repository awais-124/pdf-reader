<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PDF Text Highlighter - Fixed</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
      /* Voice-over highlight styles */
      .voice-selected {
        outline: 2px solid #2196f3 !important;
        background: rgba(33, 150, 243, 0.15) !important;
      }
      .voice-speaking {
        outline: 2px solid #ff9800 !important;
        background: rgba(255, 152, 0, 0.18) !important;
      }
      /* Voice-over cursor symbol */
      .voice-cursor {
        position: absolute;
        z-index: 10;
        pointer-events: none;
        width: 22px;
        height: 22px;
        transform: translate(-50%, -60%);
        display: none;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        user-select: none;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }
      .header {
        background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        color: white;
        padding: 30px;
        text-align: center;
      }
      .header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
      }
      .header p {
        opacity: 0.9;
        font-size: 1.1rem;
      }
      .upload-section {
        padding: 40px;
        text-align: center;
        border-bottom: 1px solid #eee;
      }
      .file-input-wrapper {
        position: relative;
        display: inline-block;
        cursor: pointer;
        background: linear-gradient(45deg, #4ecdc4, #44a08d);
        color: white;
        padding: 15px 30px;
        border-radius: 50px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 10px 30px rgba(78, 205, 196, 0.3);
      }
      .file-input-wrapper:hover {
        transform: translateY(-2px);
        box-shadow: 0 15px 40px rgba(78, 205, 196, 0.4);
      }
      .file-input {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
      }
      .controls {
        padding: 20px 40px;
        background: #f8f9fa;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
      }
      .control-group {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 14px;
      }
      .btn-highlight {
        background: linear-gradient(45deg, #feca57, #ff9ff3);
        color: white;
      }
      .btn-highlight.active {
        background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
      }
      .btn-eraser {
        background: linear-gradient(45deg, #e74c3c, #c0392b);
        color: white;
      }
      .btn-eraser.active {
        background: linear-gradient(45deg, #8e44ad, #9b59b6);
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(142, 68, 173, 0.4);
      }
      .btn-clear {
        background: linear-gradient(45deg, #fc4a1a, #f7b733);
        color: white;
      }
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      }
      .highlight-colors {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .color-picker {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 3px solid white;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }
      .color-picker.active {
        transform: scale(1.2);
        border-color: #333;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }
      .color-yellow {
        background: #ffeb3b;
      }
      .color-green {
        background: #4caf50;
      }
      .color-blue {
        background: #2196f3;
      }
      .color-pink {
        background: #e91e63;
      }
      .color-orange {
        background: #ff9800;
      }
      .zoom-controls {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .zoom-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: none;
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .zoom-btn:hover {
        transform: scale(1.1);
      }
      .viewer-container {
        padding: 40px;
        min-height: 500px;
        background: #f8f9fa;
      }
      .pdf-viewer {
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        overflow: auto;
        margin: 0 auto;
        max-width: 1000px;
        max-height: 80vh;
        position: relative;
      }
      .pdf-page {
        position: relative;
        margin: 20px auto;
        border: 1px solid #ddd;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        background: white;
        cursor: default;
      }
      .pdf-page.highlight-mode,
      .pdf-page.highlight-mode * {
        cursor: var(--highlight-cursor, pointer) !important;
        user-select: none !important;
      }
      .pdf-page.eraser-mode,
      .pdf-page.eraser-mode * {
        cursor: var(--eraser-cursor, pointer) !important;
        user-select: none !important;
      }
      .text-layer {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 2;
        pointer-events: none;
      }
      .text-layer .text-element {
        pointer-events: auto;
      }
      .text-element {
        position: absolute;
        cursor: text;
        user-select: text;
        transition: all 0.1s ease;
        border-radius: 2px;
        white-space: nowrap;
        color: #222;
        background: rgba(255, 0, 0, 0.247);
        font-family: inherit;
        line-height: 1;
        margin: 0;
        padding: 0;
        border: none;
        outline: none;
      }
      .text-element:hover {
        background: rgba(255, 107, 107, 0.1) !important;
      }
      .text-element.selecting {
        background: rgba(255, 107, 107, 0.2) !important;
      }
      .selection-box {
        position: absolute;
        border: 2px dashed #ff6b6b;
        background: rgba(255, 107, 107, 0.1);
        pointer-events: none;
        z-index: 5;
        border-radius: 3px;
      }
      .highlight-overlay {
        position: absolute;
        border-radius: 3px;
        z-index: 3;
        transition: all 0.2s ease;
        cursor: pointer;
      }
      .highlight-overlay:hover {
        opacity: 0.8 !important;
        transform: scale(1.02);
      }
      .highlight-overlay.eraser-hover {
        border: 2px dashed #e74c3c !important;
        opacity: 0.6 !important;
      }
      .loading {
        text-align: center;
        padding: 60px 20px;
        font-size: 1.2rem;
        color: #666;
      }
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .page-info {
        text-align: center;
        padding: 15px;
        background: white;
        border-top: 1px solid #eee;
        color: #666;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .no-pdf {
        text-align: center;
        padding: 100px 20px;
        color: #999;
        font-size: 1.2rem;
      }
      .highlights-info {
        display: flex;
        align-items: center;
        gap: 15px;
      }
      .status-bar {
        padding: 15px 30px;
        background: #333;
        color: white;
        font-size: 0.95rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .debug-info {
        font-family: monospace;
        font-size: 0.8rem;
        opacity: 0.7;
      }
      @media (max-width: 768px) {
        .controls {
          flex-direction: column;
          align-items: stretch;
        }
        .control-group,
        .zoom-controls {
          justify-content: center;
        }
        .page-info {
          flex-direction: column;
          gap: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>✨ OCR Zindabad</h1>
        <p>Voice / Highlight Tech</p>
      </div>
      <div class="upload-section">
        <div class="file-input-wrapper">
          <input type="file" id="pdfInput" class="file-input" accept=".pdf" />
          📄 Choose PDF File
        </div>
      </div>
      <div class="controls" id="controls" style="display: none">
        <div class="control-group" id="voiceControls" style="gap: 8px">
          <button class="btn" id="voiceStartBtn" title="Start Voice Over">
            🔊 Start
          </button>
          <button class="btn" id="voicePauseBtn" title="Pause Voice Over">
            ⏸️ Pause
          </button>
          <button class="btn" id="voiceResumeBtn" title="Resume Voice Over">
            ▶️ Resume
          </button>
          <button class="btn" id="voiceStopBtn" title="Stop Voice Over">
            ⏹️ Stop
          </button>
          <span
            id="voiceStatus"
            style="font-size: 13px; opacity: 0.7; margin-left: 8px"
          ></span>
        </div>
        <div class="control-group">
          <button
            class="btn btn-highlight"
            id="highlightBtn"
            title="Highlight Mode (H)"
          >
            🖍️ Highlight Mode
          </button>
          <button class="btn btn-eraser" id="eraserBtn" title="Eraser Mode (E)">
            🧽 Eraser Mode
          </button>
          <div class="highlight-colors">
            <div
              class="color-picker color-yellow active"
              data-color="#ffeb3b"
              title="Yellow (1)"
            ></div>
            <div
              class="color-picker color-green"
              data-color="#4caf50"
              title="Green (2)"
            ></div>
            <div
              class="color-picker color-blue"
              data-color="#2196f3"
              title="Blue (3)"
            ></div>
            <div
              class="color-picker color-pink"
              data-color="#e91e63"
              title="Pink (4)"
            ></div>
            <div
              class="color-picker color-orange"
              data-color="#ff9800"
              title="Orange (5)"
            ></div>
          </div>
          <div
            class="brush-size-group"
            style="
              margin-left: 20px;
              display: flex;
              align-items: center;
              gap: 6px;
            "
          >
            <label for="brushSize" style="font-size: 13px; opacity: 0.8"
              >Brush Size:</label
            >
            <select
              id="brushSize"
              style="padding: 4px 8px; border-radius: 8px; font-size: 14px"
              title="Brush Size"
            >
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>
        </div>
        <div class="control-group">
          <button
            class="btn btn-clear"
            id="clearBtn"
            title="Clear All Highlights (Ctrl+C)"
          >
            🧹 Clear All
          </button>
        </div>
        <div class="zoom-controls">
          <button class="zoom-btn" id="zoomOut" title="Zoom Out (Ctrl+-)">
            -
          </button>
          <span id="zoomLevel" title="Current Zoom Level">100%</span>
          <button class="zoom-btn" id="zoomIn" title="Zoom In (Ctrl++)">
            +
          </button>
          <button
            class="zoom-btn"
            id="resetZoom"
            title="Reset Zoom (Ctrl+0)"
            style="
              margin-left: 5px;
              width: auto;
              padding: 0 8px;
              font-size: 12px;
            "
          >
            100%
          </button>
        </div>
      </div>
      <div class="viewer-container">
        <div id="loadingIndicator" class="loading" style="display: none">
          <div class="spinner"></div>
          Loading and extracting text...
        </div>
        <div
          id="pdfViewer"
          class="pdf-viewer"
          style="display: none; position: relative"
        >
          <svg id="voiceCursor" class="voice-cursor" viewBox="0 0 22 22">
            <circle
              cx="11"
              cy="11"
              r="9"
              stroke="#ff9800"
              stroke-width="2"
              fill="none"
            />
            <line
              x1="11"
              y1="4"
              x2="11"
              y2="18"
              stroke="#ff9800"
              stroke-width="2"
            />
            <line
              x1="4"
              y1="11"
              x2="18"
              y2="11"
              stroke="#ff9800"
              stroke-width="2"
            />
          </svg>
        </div>
        <div id="noPdfMessage" class="no-pdf">
          📁 Upload a PDF file to start highlighting text with click & drag
        </div>
      </div>
      <div class="page-info" id="pageInfo" style="display: none">
        <div>
          <span id="pageNumber">Page 1</span> of <span id="totalPages">1</span>
        </div>
        <div class="highlights-info">
          <strong>Highlights: <span id="highlightCount">0</span></strong>
        </div>
      </div>
      <div class="status-bar" id="statusBar" style="display: none">
        <span id="statusText">Ready to highlight</span>
        <div class="shortcuts-hint" style="font-size: 0.8rem; opacity: 0.7">
          💡 Shortcuts: H=Highlight | E=Eraser | Ctrl+Wheel=Zoom | Ctrl+0=Reset
          | ESC=Exit
        </div>
        <span id="debugInfo" class="debug-info"></span>
      </div>
    </div>
    <script>
      class PDFHighlighter {
        constructor() {
          this.voiceStartIndex = null;
          this.voiceUtterance = null;
          this.voicePaused = false;
          this.voiceActive = false;
          this.pdf = null;
          this.scale = 1.0;
          this.highlightMode = false;
          this.eraserMode = false;
          this.highlights = new Map();
          this.highlightCounter = 0;
          this.textItems = [];
          this.textItemsByPage = new Map();
          this.currentColor = '#ffeb3b';
          this.isSelecting = false;
          this.selectionStart = null;
          this.selectionBox = null;
          this.selectedElements = [];
          this.brushSize = 1;
          this.init();
        }

        init() {
          pdfjsLib.GlobalWorkerOptions.workerSrc =
            'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
          this.bindEvents();
        }

        bindEvents() {
          // Voice controls
          document
            .getElementById('voiceStartBtn')
            .addEventListener('click', () => this.startVoiceOver());
          document
            .getElementById('voicePauseBtn')
            .addEventListener('click', () => this.pauseVoiceOver());
          document
            .getElementById('voiceResumeBtn')
            .addEventListener('click', () => this.resumeVoiceOver());
          document
            .getElementById('voiceStopBtn')
            .addEventListener('click', () => this.stopVoiceOver());
          document.getElementById('voiceStatus').textContent = '';
          document
            .getElementById('pdfInput')
            .addEventListener('change', (e) => this.handleFileUpload(e));
          document
            .getElementById('highlightBtn')
            .addEventListener('click', () => this.toggleHighlightMode());
          document
            .getElementById('eraserBtn')
            .addEventListener('click', () => this.toggleEraserMode());
          document
            .getElementById('clearBtn')
            .addEventListener('click', () => this.clearAllHighlights());
          document
            .getElementById('zoomIn')
            .addEventListener('click', () => this.zoom(1.25));
          document
            .getElementById('zoomOut')
            .addEventListener('click', () => this.zoom(0.8));
          document
            .getElementById('resetZoom')
            .addEventListener('click', () => this.resetZoom());
          document.addEventListener('keydown', (e) =>
            this.handleKeyboardShortcuts(e)
          );
          document
            .getElementById('pdfViewer')
            .addEventListener('wheel', (e) => this.handleWheelZoom(e));
          document.querySelectorAll('.color-picker').forEach((picker) => {
            picker.addEventListener('click', (e) => this.selectColor(e));
          });
          document
            .getElementById('brushSize')
            .addEventListener('change', (e) => {
              this.brushSize = parseInt(e.target.value);
              this.updateBrushCursor();
            });
          this.updateBrushCursor();
        }
        clearVoiceSelection() {
          document
            .querySelectorAll('.voice-selected')
            .forEach((el) => el.classList.remove('voice-selected'));
          document
            .querySelectorAll('.voice-speaking')
            .forEach((el) => el.classList.remove('voice-speaking'));
          this.hideVoiceCursor();
        }

        startVoiceOver() {
          if (!window.speechSynthesis) {
            alert('Speech Synthesis not supported in this browser.');
            return;
          }

          if (this.voiceActive) {
            this.stopVoiceOver();
          }

          let startIdx = this.voiceStartIndex ?? 0;
          const items = this.textItems.filter((item) => item.index >= startIdx);
          if (items.length === 0) {
            document.getElementById('voiceStatus').textContent =
              'No text to read.';
            return;
          }
          const text = items.map((i) => i.text).join('');
          this.voiceUtterance = new window.SpeechSynthesisUtterance(text);
          this.voiceUtterance.rate = 1.0;
          this.voiceUtterance.onboundary = (event) => {
            if (
              event.name === 'word' ||
              event.name === 'sentence' ||
              event.charIndex !== undefined
            ) {
              this.highlightSpokenChar(startIdx + event.charIndex);
            }
          };
          this.voiceUtterance.onend = () => {
            this.voiceActive = false;
            this.voicePaused = false;
            this.clearVoiceSelection();
            document.getElementById('voiceStatus').textContent =
              'Voice over finished.';
          };
          this.voiceUtterance.onerror = () => {
            this.voiceActive = false;
            this.voicePaused = false;
            this.clearVoiceSelection();
            document.getElementById('voiceStatus').textContent =
              'Voice over error.';
          };
          this.voiceActive = true;
          this.voicePaused = false;
          this.clearVoiceSelection();
          document.getElementById('voiceStatus').textContent =
            'Voice over playing...';
          window.speechSynthesis.cancel();
          window.speechSynthesis.speak(this.voiceUtterance);
        }

        pauseVoiceOver() {
          if (window.speechSynthesis && this.voiceActive && !this.voicePaused) {
            window.speechSynthesis.pause();
            this.voicePaused = true;
            document.getElementById('voiceStatus').textContent =
              'Voice over paused.';
          }
        }

        resumeVoiceOver() {
          if (window.speechSynthesis && this.voiceActive && this.voicePaused) {
            window.speechSynthesis.resume();
            this.voicePaused = false;
            document.getElementById('voiceStatus').textContent =
              'Voice over resumed.';
          }
        }

        stopVoiceOver() {
          if (
            window.speechSynthesis &&
            (this.voiceActive || this.voicePaused)
          ) {
            window.speechSynthesis.cancel();
            this.voiceActive = false;
            this.voicePaused = false;
            this.clearVoiceSelection();
            document.getElementById('voiceStatus').textContent =
              'Voice over stopped.';
          }
        }

        highlightSpokenChar(idx) {
          this.clearVoiceSelection();
          const el = this.textItems.find((item) => item.index === idx)?.element;
          if (el) {
            el.classList.add('voice-speaking');
            this.showVoiceCursor(el);
          } else {
            this.hideVoiceCursor();
          }
        }

        showVoiceCursor(el) {
          const cursor = document.getElementById('voiceCursor');
          if (!cursor || !el) return;
          const viewer = document.getElementById('pdfViewer');
          const elRect = el.getBoundingClientRect();
          const viewerRect = viewer.getBoundingClientRect();
          const left = elRect.left - viewerRect.left + elRect.width / 2;
          const top = elRect.top - viewerRect.top + elRect.height / 2;
          cursor.style.left = `${left}px`;
          cursor.style.top = `${top}px`;
          cursor.style.display = 'block';
        }

        hideVoiceCursor() {
          const cursor = document.getElementById('voiceCursor');
          if (cursor) cursor.style.display = 'none';
        }

        handleKeyboardShortcuts(e) {
          if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT')
            return;

          switch (e.key) {
            case 'h':
            case 'H':
              if (!e.ctrlKey && !e.altKey) {
                this.toggleHighlightMode();
                e.preventDefault();
              }
              break;
            case 'e':
            case 'E':
              if (!e.ctrlKey && !e.altKey) {
                this.toggleEraserMode();
                e.preventDefault();
              }
              break;
            case 'c':
            case 'C':
              if (e.ctrlKey && !e.altKey) {
                this.clearAllHighlights();
                e.preventDefault();
              }
              break;
            case '=':
            case '+':
              if (e.ctrlKey) {
                this.zoom(1.25);
                e.preventDefault();
              }
              break;
            case '-':
              if (e.ctrlKey) {
                this.zoom(0.8);
                e.preventDefault();
              }
              break;
            case '0':
              if (e.ctrlKey) {
                this.resetZoom();
                e.preventDefault();
              }
              break;
            case 'Escape':
              this.exitAllModes();
              break;
          }
        }

        handleWheelZoom(e) {
          if (e.ctrlKey) {
            e.preventDefault();
            const factor = e.deltaY > 0 ? 0.9 : 1.1;
            this.zoom(factor);
          }
        }

        resetZoom() {
          if (this.scale !== 1.0) {
            this.scale = 1.0;
            document.getElementById('zoomLevel').textContent = '100%';
            this.updateBrushCursor();
            this.showLoading();
            this.updateStatus('Resetting zoom...');
            setTimeout(async () => {
              await this.renderAllPages();
              this.updateBrushCursor();
              this.updateStatus('Zoom reset to 100%');
            }, 10);
          }
        }

        exitAllModes() {
          if (this.highlightMode) this.toggleHighlightMode();
          if (this.eraserMode) this.toggleEraserMode();
          this.updateStatus('All modes disabled');
        }

        updateBrushCursor() {
          const base = 16;
          const scale = Math.min(this.scale || 1.0, 2.0);
          const size = Math.max(base * this.brushSize * scale, 12);
          const strokeWidth = Math.max(2, size * 0.1);

          const svgHighlight = `<svg xmlns='http://www.w3.org/2000/svg' width='${size}' height='${size}' viewBox='0 0 ${size} ${size}'><circle cx='${
            size / 2
          }' cy='${size / 2}' r='${
            size / 2 - strokeWidth
          }' fill='rgba(255,235,59,0.2)' stroke='%23fbc02d' stroke-width='${strokeWidth}'/></svg>`;
          const svgEraser = `<svg xmlns='http://www.w3.org/2000/svg' width='${size}' height='${size}' viewBox='0 0 ${size} ${size}'><circle cx='${
            size / 2
          }' cy='${size / 2}' r='${
            size / 2 - strokeWidth
          }' fill='rgba(244,67,54,0.1)' stroke='%23e53935' stroke-width='${strokeWidth}'/></svg>`;

          const highlightCursor = `url('data:image/svg+xml;utf8,${encodeURIComponent(
            svgHighlight
          )}') ${size / 2} ${size / 2}, crosshair`;
          const eraserCursor = `url('data:image/svg+xml;utf8,${encodeURIComponent(
            svgEraser
          )}') ${size / 2} ${size / 2}, crosshair`;

          document.documentElement.style.setProperty(
            '--highlight-cursor',
            highlightCursor
          );
          document.documentElement.style.setProperty(
            '--eraser-cursor',
            eraserCursor
          );
        }

        selectColor(event) {
          document
            .querySelectorAll('.color-picker')
            .forEach((p) => p.classList.remove('active'));
          event.target.classList.add('active');
          this.currentColor = event.target.dataset.color;
          this.updateStatus(`Selected ${event.target.title} highlighter`);
        }

        async handleFileUpload(event) {
          const file = event.target.files[0];
          if (!file || file.type !== 'application/pdf') {
            alert('Please select a valid PDF file');
            return;
          }
          this.highlights.clear();
          this.highlightCounter = 0;
          this.textItems = [];
          this.textItemsByPage.clear();
          this.voiceStartIndex = null;
          this.voiceUtterance = null;
          this.voicePaused = false;
          this.voiceActive = false;
          this.clearVoiceSelection();
          const viewer = document.getElementById('pdfViewer');
          if (viewer) viewer.innerHTML = '';
          document.getElementById('pageInfo').style.display = 'none';
          document.getElementById('statusBar').style.display = 'none';
          document.getElementById('highlightCount').textContent = '0';
          document.getElementById('voiceStatus').textContent = '';
          this.scale = 1.0;
          document.getElementById('zoomLevel').textContent = '100%';
          this.showLoading();
          this.updateStatus('Loading PDF...');
          try {
            const arrayBuffer = await file.arrayBuffer();
            this.pdf = await pdfjsLib.getDocument({ data: arrayBuffer })
              .promise;
            await this.renderAllPages();
            this.showControls();
            this.updateStatus('PDF loaded - Ready to highlight');
          } catch (error) {
            console.error('Error loading PDF:', error);
            alert('Error loading PDF file');
            this.hideLoading();
          }
        }

        async renderAllPages() {
          const viewer = document.getElementById('pdfViewer');
          viewer.innerHTML = '';
          document.getElementById('totalPages').textContent = this.pdf.numPages;
          this.textItems = [];

          for (let pageNum = 1; pageNum <= this.pdf.numPages; pageNum++) {
            await this.renderPage(pageNum);
          }
          this.redrawAllHighlights();
          this.hideLoading();
          viewer.style.display = 'block';
          document.getElementById('pageInfo').style.display = 'flex';
          document.getElementById('statusBar').style.display = 'flex';
          this.updateHighlightCount();
        }

        async renderPage(pageNum) {
          const page = await this.pdf.getPage(pageNum);
          const viewport = page.getViewport({ scale: this.scale });
          const pageDiv = document.createElement('div');
          pageDiv.className = 'pdf-page';
          pageDiv.style.width = viewport.width + 'px';
          pageDiv.style.height = viewport.height + 'px';
          pageDiv.dataset.pageNumber = pageNum;

          const canvas = document.createElement('canvas');
          const context = canvas.getContext('2d');
          canvas.width = viewport.width;
          canvas.height = viewport.height;
          pageDiv.appendChild(canvas);

          await page.render({
            canvasContext: context,
            viewport: viewport,
          }).promise;

          const textLayerDiv = document.createElement('div');
          textLayerDiv.className = 'text-layer';
          pageDiv.appendChild(textLayerDiv);

          let textItems;
          if (this.textItemsByPage.has(pageNum)) {
            textItems = this.textItemsByPage.get(pageNum);
          } else {
            const textContent = await page.getTextContent();
            textItems = this.createTextElements(
              textContent,
              textLayerDiv,
              viewport,
              pageNum,
              true
            );
            this.textItemsByPage.set(pageNum, textItems);
          }

          this.createTextElements(null, textLayerDiv, viewport, pageNum, false);
          this.addPageEventHandlers(pageDiv);
          document.getElementById('pdfViewer').appendChild(pageDiv);
        }

        createTextElements(
          textContent,
          textLayerDiv,
          viewport,
          pageNum,
          extract
        ) {
          let charIndex = 0;
          let items = [];
          if (extract && textContent) {
            textContent.items.forEach((textItem, index) => {
              const str = textItem.str;
              const charCount = str.length;
              if (charCount === 0) return;
              const transform = textItem.transform;
              const [scaleX, skewY, skewX, scaleY, x, y] = transform;
              const fontSize = Math.sqrt(scaleX * scaleX + skewY * skewY);
              const adjustedY = viewport.height - y;
              const approximateWidth = textItem.width;
              const charWidth = approximateWidth / charCount;
              let charX = x;
              for (let i = 0; i < charCount; i++) {
                const ch = str[i];
                items.push({
                  text: ch,
                  baseX: charX,
                  baseY: adjustedY - fontSize,
                  baseWidth: charWidth,
                  baseHeight: fontSize,
                  fontName: textContent.styles[textItem.fontName].fontFamily,
                  scaleX: scaleX,
                  fontSize: fontSize,
                  pageNum: pageNum,
                  index: charIndex,
                });
                charX += charWidth;
                charIndex++;
              }
            });
            return items;
          } else {
            items = this.textItemsByPage.get(pageNum) || [];
            items.forEach((item, idx) => {
              const textElement = document.createElement('div');
              textElement.className = 'text-element';
              textElement.textContent =
                item.text === ' ' ? '\u00A0' : item.text;
              textElement.dataset.pageNumber = pageNum;
              textElement.dataset.textIndex = item.index;
              const scale = this.scale || 1.0;
              textElement.style.left = item.baseX * scale + 'px';
              textElement.style.top = item.baseY * scale + 'px';
              textElement.style.fontSize = item.baseHeight * scale + 'px';
              textElement.style.fontFamily = item.fontName;
              textElement.style.transform = `scaleX(${
                item.scaleX / item.fontSize
              })`;
              textElement.style.transformOrigin = 'left bottom';
              item.x = item.baseX * scale;
              item.y = item.baseY * scale;
              item.width = item.baseWidth * scale;
              item.height = item.baseHeight * scale;
              item.element = textElement;
              textLayerDiv.appendChild(textElement);
              this.textItems.push(item);
              // Voice selection: click to set start index
              textElement.addEventListener('click', (e) => {
                e.stopPropagation();
                this.voiceStartIndex = item.index;
                this.clearVoiceSelection();
                textElement.classList.add('voice-selected');
                document.getElementById(
                  'voiceStatus'
                ).textContent = `Voice will start from selected character.`;
              });
            });
          }
        }

        addPageEventHandlers(pageDiv) {
          let isDragging = false;
          let dragElements = new Set();
          let dragHighlightId = null;
          let dragColor = null;
          let dragMode = null;

          const onMouseMove = (e) => {
            if (!isDragging) return;
            const rect = pageDiv.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const pageNum = parseInt(pageDiv.dataset.pageNumber);
            const base = 18;
            const scale = this.scale || 1.0;
            const radius = (base * this.brushSize * scale) / 2;

            const itemsInBrush = this.textItems.filter((item) => {
              return (
                item.pageNum === pageNum &&
                Math.hypot(
                  item.x + item.width / 2 - x,
                  item.y + item.height / 2 - y
                ) <= radius
              );
            });
            if (dragMode === 'highlight') {
              const toHighlight = itemsInBrush.filter(
                (item) => !this.isTextItemHighlighted(item)
              );
              if (toHighlight.length > 0) {
                this.createHighlight(
                  toHighlight,
                  true,
                  dragHighlightId,
                  dragColor
                );
                toHighlight.forEach((item) => dragElements.add(item));
              }
            } else if (dragMode === 'erase') {
              itemsInBrush.forEach((item) => {
                let topHighlightId = null;
                let topHighlightIdx = -1;
                for (const [id, highlight] of Array.from(
                  this.highlights.entries()
                ).sort((a, b) => b[0] - a[0])) {
                  const idx = highlight.elements.findIndex(
                    (el2) =>
                      el2.pageNum === item.pageNum && el2.index === item.index
                  );
                  if (idx !== -1) {
                    topHighlightId = id;
                    topHighlightIdx = idx;
                    break;
                  }
                }
                if (topHighlightId !== null && topHighlightIdx !== -1) {
                  const highlight = this.highlights.get(topHighlightId);
                  const overlay = highlight.overlays[topHighlightIdx];
                  if (overlay && overlay.parentNode)
                    overlay.parentNode.removeChild(overlay);
                  highlight.elements.splice(topHighlightIdx, 1);
                  highlight.overlays.splice(topHighlightIdx, 1);
                  if (highlight.elements.length === 0) {
                    this.highlights.delete(topHighlightId);
                  }
                  this.updateHighlightCount();
                }
              });
            }
          };

          pageDiv.addEventListener('mousedown', (e) => {
            if ((this.highlightMode || this.eraserMode) && e.button === 0) {
              isDragging = true;
              dragElements = new Set();
              dragHighlightId = null;
              dragColor = this.currentColor;
              dragMode = this.highlightMode ? 'highlight' : 'erase';
              if (this.highlightMode) pageDiv.classList.add('highlight-mode');
              if (this.eraserMode) pageDiv.classList.add('eraser-mode');
              document.addEventListener('mousemove', onMouseMove);
            }
          });
          document.addEventListener('mouseup', (e) => {
            if (isDragging) {
              isDragging = false;
              dragElements = new Set();
              dragHighlightId = null;
              dragMode = null;
              document.removeEventListener('mousemove', onMouseMove);
            }
          });
          pageDiv.addEventListener('mouseleave', () => {
            if (isDragging) {
              isDragging = false;
              dragElements = new Set();
              dragHighlightId = null;
              dragMode = null;
              document.removeEventListener('mousemove', onMouseMove);
            }
          });
          pageDiv.addEventListener('mouseenter', () => {
            if (this.highlightMode) {
              pageDiv.classList.add('highlight-mode');
            } else if (this.eraserMode) {
              pageDiv.classList.add('eraser-mode');
            }
          });
        }

        handleEraserClick(event) {
          const target = event.target;
          if (target && target.classList.contains('highlight-overlay')) {
            event.preventDefault();
            event.stopPropagation();
            const highlightId = target.dataset.highlightId;
            if (highlightId) {
              this.removeHighlight(highlightId);
            }
          }
        }

        updateEraserHover(pageDiv, isEntering) {
          const overlays = pageDiv.querySelectorAll('.highlight-overlay');
          overlays.forEach((overlay) => {
            if (isEntering) {
              overlay.addEventListener(
                'mouseenter',
                this.addEraserHover.bind(this)
              );
              overlay.addEventListener(
                'mouseleave',
                this.removeEraserHover.bind(this)
              );
            } else {
              overlay.removeEventListener(
                'mouseenter',
                this.addEraserHover.bind(this)
              );
              overlay.removeEventListener(
                'mouseleave',
                this.removeEraserHover.bind(this)
              );
              overlay.classList.remove('eraser-hover');
            }
          });
        }

        addEraserHover(event) {
          if (this.eraserMode) {
            event.target.classList.add('eraser-hover');
          }
        }

        removeEraserHover(event) {
          event.target.classList.remove('eraser-hover');
        }

        createHighlight(
          items,
          singleHighlightMode = false,
          highlightId = null,
          color = null
        ) {
          let id = highlightId;
          if (!id) id = ++this.highlightCounter;
          const selectedTexts = [];
          const overlays = [];
          items.forEach((item) => {
            if (this.isTextItemHighlighted(item)) return;
            const overlay = document.createElement('div');
            overlay.className = 'highlight-overlay';
            overlay.style.position = 'absolute';
            overlay.style.left = item.x + 'px';
            overlay.style.top = item.y + 'px';
            overlay.style.width = item.width + 'px';
            overlay.style.height = item.height + 'px';
            overlay.style.background = this.hexToRgba(
              color || this.currentColor,
              0.4
            );
            overlay.dataset.highlightId = id.toString();
            const pageDiv = item.element.closest('.pdf-page');
            pageDiv.appendChild(overlay);
            overlays.push(overlay);
            selectedTexts.push(item.text);
          });

          if (singleHighlightMode && this.highlights.has(id)) {
            const prev = this.highlights.get(id);
            prev.text += ' ' + selectedTexts.join(' ');
            prev.overlays.push(...overlays);
            prev.elements.push(...items);
          } else {
            this.highlights.set(id, {
              id: id,
              text: selectedTexts.join(' '),
              color: color || this.currentColor,
              overlays: overlays,
              elements: [...items],
            });
          }
          this.updateHighlightCount();
          if (!singleHighlightMode) {
            this.updateStatus(
              `Highlighted: "${selectedTexts.join(' ').substring(0, 50)}..."`
            );
          }
        }

        isTextItemHighlighted(item) {
          for (const highlight of this.highlights.values()) {
            if (
              highlight.elements.some(
                (el) => el.pageNum === item.pageNum && el.index === item.index
              )
            ) {
              return true;
            }
          }
          return false;
        }

        redrawAllHighlights() {
          this.highlights.forEach((highlight) => {
            const newOverlays = [];
            highlight.elements.forEach((itemData) => {
              const newTextItem = this.textItems.find(
                (item) =>
                  item.pageNum === itemData.pageNum &&
                  item.index === itemData.index
              );
              if (newTextItem) {
                const overlay = document.createElement('div');
                overlay.className = 'highlight-overlay';
                overlay.style.position = 'absolute';
                overlay.style.left = newTextItem.x + 'px';
                overlay.style.top = newTextItem.y + 'px';
                overlay.style.width = newTextItem.width + 'px';
                overlay.style.height = newTextItem.height + 'px';
                overlay.style.background = this.hexToRgba(highlight.color, 0.4);
                overlay.dataset.highlightId = highlight.id.toString();

                const pageDiv = newTextItem.element.closest('.pdf-page');
                if (pageDiv) {
                  pageDiv.appendChild(overlay);
                  newOverlays.push(overlay);
                }
              }
            });
            highlight.overlays = newOverlays;
          });
        }

        removeHighlight(highlightId) {
          const id = parseInt(highlightId);
          const highlight = this.highlights.get(id);
          if (!highlight) return;
          highlight.overlays.forEach((overlay) =>
            overlay.parentNode?.removeChild(overlay)
          );
          this.highlights.delete(id);
          this.updateHighlightCount();
          this.updateStatus(
            `Highlight removed (${this.highlights.size} remaining)`
          );
        }

        clearAllHighlights() {
          if (this.highlights.size === 0) {
            this.updateStatus('No highlights to clear');
            return;
          }
          const count = this.highlights.size;
          if (
            confirm(`Clear all ${count} highlights? This cannot be undone.`)
          ) {
            this.highlights.forEach((highlight) => {
              highlight.overlays.forEach((overlay) =>
                overlay.parentNode?.removeChild(overlay)
              );
            });
            this.highlights.clear();
            this.updateHighlightCount();
            this.updateStatus(`All ${count} highlights cleared`);
          }
        }

        toggleHighlightMode() {
          this.eraserMode = false;
          document.getElementById('eraserBtn').classList.remove('active');
          document.getElementById('eraserBtn').textContent = '🧽 Eraser Mode';
          this.highlightMode = !this.highlightMode;
          const btn = document.getElementById('highlightBtn');
          document.querySelectorAll('.pdf-page').forEach((pageDiv) => {
            if (this.highlightMode) {
              pageDiv.classList.add('highlight-mode');
              pageDiv.classList.remove('eraser-mode');
            } else {
              pageDiv.classList.remove('highlight-mode');
            }
          });
          if (this.highlightMode) {
            btn.classList.add('active');
            btn.textContent = '✋ Exit Highlight Mode';
            this.updateStatus('Highlight mode ON - Click and drag to select');
          } else {
            btn.classList.remove('active');
            btn.textContent = '🖍️ Highlight Mode';
            this.updateStatus('Highlight mode OFF');
          }
        }

        toggleEraserMode() {
          this.highlightMode = false;
          document.getElementById('highlightBtn').classList.remove('active');
          document.getElementById('highlightBtn').textContent =
            '🖍️ Highlight Mode';
          this.eraserMode = !this.eraserMode;
          const btn = document.getElementById('eraserBtn');
          document.querySelectorAll('.pdf-page').forEach((pageDiv) => {
            if (this.eraserMode) {
              pageDiv.classList.add('eraser-mode');
              pageDiv.classList.remove('highlight-mode');
            } else {
              pageDiv.classList.remove('eraser-mode');
            }
          });
          if (this.eraserMode) {
            btn.classList.add('active');
            btn.textContent = '✋ Exit Eraser Mode';
            this.updateStatus('Eraser mode ON - Click a highlight to remove');
          } else {
            btn.classList.remove('active');
            btn.textContent = '🧽 Eraser Mode';
            this.updateStatus('Eraser mode OFF');
          }
        }

        async zoom(factor) {
          const viewer = document.getElementById('pdfViewer');
          const viewerRect = viewer.getBoundingClientRect();
          const scrollLeft = viewer.scrollLeft;
          const scrollTop = viewer.scrollTop;

          let mouseX = null,
            mouseY = null;
          if (window.lastMouseEvent) {
            const clientX = window.lastMouseEvent.clientX;
            const clientY = window.lastMouseEvent.clientY;

            if (
              clientX >= viewerRect.left &&
              clientX <= viewerRect.right &&
              clientY >= viewerRect.top &&
              clientY <= viewerRect.bottom
            ) {
              mouseX = clientX - viewerRect.left + scrollLeft;
              mouseY = clientY - viewerRect.top + scrollTop;
            }
          }

          const oldScale = this.scale;
          this.scale *= factor;
          this.scale = Math.max(0.25, Math.min(this.scale, 5.0));
          const scaleRatio = this.scale / oldScale;

          document.getElementById('zoomLevel').textContent = `${Math.round(
            this.scale * 100
          )}%`;
          this.updateBrushCursor();

          this.showLoading();
          this.updateStatus('Zooming and re-rendering...');

          await new Promise((resolve) => setTimeout(resolve, 10));
          await this.renderAllPages();
          this.updateBrushCursor();

          if (mouseX !== null && mouseY !== null) {
            const newMouseX = mouseX * scaleRatio;
            const newMouseY = mouseY * scaleRatio;
            const newScrollLeft =
              newMouseX - (window.lastMouseEvent.clientX - viewerRect.left);
            const newScrollTop =
              newMouseY - (window.lastMouseEvent.clientY - viewerRect.top);

            viewer.scrollLeft = Math.max(0, newScrollLeft);
            viewer.scrollTop = Math.max(0, newScrollTop);
          } else {
            viewer.scrollLeft = scrollLeft * scaleRatio;
            viewer.scrollTop = scrollTop * scaleRatio;
          }

          this.updateStatus('Zoom complete - Ready to highlight');
        }

        showLoading() {
          document.getElementById('loadingIndicator').style.display = 'block';
          document.getElementById('pdfViewer').style.display = 'none';
          document.getElementById('noPdfMessage').style.display = 'none';
        }

        hideLoading() {
          document.getElementById('loadingIndicator').style.display = 'none';
        }

        showControls() {
          document.getElementById('controls').style.display = 'flex';
        }

        updateStatus(text) {
          document.getElementById('statusText').textContent = text;
          this.updateDebugInfo();
        }

        updateHighlightCount() {
          document.getElementById('highlightCount').textContent =
            this.highlights.size;
        }

        updateDebugInfo() {
          if (!this.pdf) return;
          const debugText = `Scale: ${this.scale.toFixed(2)} | Highlights: ${
            this.highlights.size
          } | TextItems: ${this.textItems.length}`;
          document.getElementById('debugInfo').textContent = debugText;
        }

        hexToRgba(hex, alpha) {
          const r = parseInt(hex.slice(1, 3), 16);
          const g = parseInt(hex.slice(3, 5), 16);
          const b = parseInt(hex.slice(5, 7), 16);
          return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }
      }

      const pdfHighlighter = new PDFHighlighter();
      window.addEventListener('mousemove', function (e) {
        window.lastMouseEvent = e;
      });
    </script>
  </body>
</html>
